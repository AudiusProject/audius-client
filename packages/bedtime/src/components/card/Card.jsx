import { h, createContext } from 'preact'
import { useEffect, useState, useContext, useMemo, useRef } from 'preact/hooks'
import cn from 'classnames'

import styles from './Card.module.css'
import TwitterFooter from '../twitterfooter/TwitterFooter'
import { isMobileWebTwitter } from '../../util/isMobileWebTwitter'

const ASPECT_RATIOS = {
  standard: 0.833,
  twitter: 0.728
}


export const CardDimensionsContext = createContext({
  height: 0,
  width: 0,
  setDimensions: (dimension) => { }
})

export const CardContextProvider = (props) => {
  const [dimensions, setDimensions] = useState({ height: 0, width: 0 })

  return (
    <CardDimensionsContext.Provider
      value={{
        height: dimensions.height,
        width: dimensions.width,
        setDimensions
      }}
    >
      {props.children}
    </CardDimensionsContext.Provider>
  )
}

const setCardSize = (setCardStyle, cardRef, mobileWebTwitter, isTwitter) => {
  // Specialcase check for mobile twitter
  // If it's a square aspect ratio and
  // below a certain width, we should render
  // the card square fullscreen.
  if (mobileWebTwitter) {
    setCardStyle({
      height: `${window.document.documentElement.clientHeight}px`,
      width: `${window.document.documentElement.clientWidth}px`
    })
    return
  }

  const aspectRatio = isTwitter ? ASPECT_RATIOS.twitter : ASPECT_RATIOS.standard
  const viewportAspectRatio = (window.document.body.clientWidth / window.document.body.clientHeight)

  if (aspectRatio < viewportAspectRatio) {
    // In this case, we have 'extra' width so height is the constraining factor
    setCardStyle({
      height: `${cardRef.current?.parentElement.clientHeight}px`,
      width: `${cardRef.current?.parentElement.clientHeight * aspectRatio}px`
    })
  } else {
    // Extra height, so width constrains.
    setCardStyle({
      height: `${cardRef.current?.parentElement.clientWidth / aspectRatio}px`,
      width: `${cardRef.current?.parentElement.clientWidth}px`
    })
  }
}

const Card = ({
  isTwitter,
  backgroundColor,
  twitterURL,
  children,
  className
}) => {
  const [cardStyle, setCardStyle] = useState({})

  // Need to make the injected BG color slightly transparent
  const transparentBg = `${backgroundColor.slice(0, backgroundColor.length - 1)}, 0.5)`
  const mobileWebTwitter = isMobileWebTwitter(isTwitter)
  // Don't display dropshadow on mobile web twitter
  // bc we want to display it fullscreen
  const displayTwitterFooter = isTwitter && !mobileWebTwitter
  const getDropshadow = () => (isTwitter && !mobileWebTwitter ? { boxShadow: `0 3px 34px 0 ${transparentBg}` } : {})
  // No border radius on mobile web twitter
  const getBorderRadius = () => mobileWebTwitter ? 0 : 12
  const height = cardStyle.height

  const cardRef = useRef()
  const { setDimensions } = useContext(CardDimensionsContext)

  useEffect(() => {
    const resizeEventListener = () => {
      setCardSize(setCardStyle, cardRef, mobileWebTwitter, isTwitter)
    }

    resizeEventListener()
    window.addEventListener('resize', resizeEventListener);
    return () => {
      window.removeEventListener('resize', resizeEventListener);
    }
  }, [setCardSize, setCardStyle, cardRef, mobileWebTwitter, isTwitter])

  useMemo(() => {
    if (!cardStyle.width || cardStyle.width === 0) {
      return
    }
    // Feed the style into the card dimensions context
    const newStyle = {
      width: parseInt(cardStyle.width.replace('px', '')),
      height: parseInt(cardStyle.height.replace('px', ''))
    }
    setDimensions(newStyle)
  }, [height])

  return (
    <div
      className={cn(styles.container, className)}
      style={{
        backgroundColor,
        ...cardStyle,
        ...getDropshadow(),
        ...{ borderRadius: `${getBorderRadius()}px` }
      }}
      ref={cardRef}
    >
      {children}
      {
        displayTwitterFooter &&
        <div
          className={styles.twitterContainer}
          style={{
            borderBottomLeftRadius: `${getBorderRadius()}px`,
            borderBottomRightRadius: `${getBorderRadius()}px`
          }}
        >
          <TwitterFooter onClickPath={twitterURL} />
        </div>
      }
    </div>
  )
}

export default Card
